#!/bin/bash
set -euo pipefail

# <bitbar.title>Syncthing</bitbar.title>
# <bitbar.version>v0.1</bitbar.version>
# <bitbar.author>blockloop</bitbar.author>
# <bitbar.author.github>blockloop</bitbar.author.github>
# <bitbar.desc>Monitor the status of your local (or remote) Syncthing</bitbar.desc>
# <bitbar.image>https://blockloop.nyc3.digitaloceanspaces.com/images/syncthing.png</birtbar.image>
# <bitbar.dependencies>curl</bitbar.dependencies>
# <bitbar.dependencies>jq</bitbar.dependencies>
# <bitbar.dependencies>bc</bitbar.dependencies>
# <bitbar.dependencies>nslookup</bitbar.dependencies>
# <bitbar.dependencies>awk</bitbar.dependencies>
# <bitbar.dependencies>xargs</bitbar.dependencies>
# <bitbar.dependencies>sed</bitbar.dependencies>
# <bitbar.dependencies>tac</bitbar.dependencies>

PATH="/usr/local/bin:/usr/local/opt/coreutils/libexec/gnubin:$PATH"
API_KEY=""
HOST="http://127.0.0.1:8384"
# color image
ICON_DEFAULT="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"
ICON_NOTIFY="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"
ICON_PAUSE="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"
ICON_SYNC="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"

function hostnameForIP() {
        if [ -z "$1" ]; then
                return
        fi

        port="$(echo "$1" | awk -F: '{print $NF}')"
        ip="${1//:$port/}"
        # strip IPv6 brackets
        ip="${ip//[][]/}"
        hname="$(nslookup "$ip" | awk -F'= ' '{ print $2 } ' | xargs)"
        if [ -n "$hname" ]; then
                echo "${hname//\.$/}"
        else
                echo "$ip"
        fi
}

[ -z "$API_KEY" ] && echo "ERROR" && echo "Open this file and set your API_KEY!" && exit 1

if ! curl -s -m 1 "$HOST/rest/system/ping" &> /dev/null; then
        echo "| image=${ICON_NOTIFY}"
        echo "---"
        echo "Open | href=${HOST}"
        echo "State: Not connected"
        echo "Host: $HOST"
        exit 0
fi

STATUS="$(curl -s -m 2 -H "X-API-KEY:$API_KEY" $HOST/rest/system/status)"
uptime_s="$(echo "$STATUS" | jq -r '.uptime')"
uptime_m="$((uptime_s / 60))"
uptime_h="$((uptime_m / 60))"
uptime_d="$((uptime_h / 24))"

uptime_m="$((uptime_m % 60))"
uptime_h="$((uptime_h % 24))"

CONNS="$(curl -s -m 2 -H "X-API-KEY:$API_KEY" $HOST/rest/system/connections)"
CON_ADDRS="$(echo "$CONNS" | jq -r '.connections[] | select(.connected == true) | .address')"

STATE="$(curl -s -m 2 -H "X-API-KEY:$API_KEY" "$HOST/rest/events?event=StateChanged&limit=1")"
CHANGES="$(curl -s -m 2 -H "X-API-KEY:$API_KEY" "$HOST/rest/events?events=LocalChangeDetected,RemoteChangeDetected&limit=5")"

cpu="$(echo "$STATUS" | jq -r .cpuPercent)"
cpu=$(echo "scale=2;$cpu*100" |bc)

state="$(echo "$STATE" | jq -r '.[].data.to')"
[ "$state" == "null" ] && state='idle'

ICON=$ICON_DEFAULT
if [ "$state" == "scanning" ] || [ "$state" == "syncing" ]; then
        ICON=$ICON_SYNC
elif [ "$state" == "paused" ]; then
        ICON=$ICON_PAUSE
elif [ "$state" == "error" ]; then
        ICON=$ICON_NOTIFY
fi

echo "| image=${ICON}"
echo '---'
echo "Open | href=${HOST}"
echo "State: $state"
echo "Uptime: ${uptime_d}d ${uptime_h}h ${uptime_m}m"
printf "CPU: %.*f%%\\n" 2 "$cpu"
echo '---'

echo "Connections"
if [ -z "$CON_ADDRS" ]; then
        echo "None"
else
        for addr in $CON_ADDRS; do
                echo -n '- '
                hostnameForIP "$addr"
        done
fi

echo '---'
echo "Recent Changes"
echo "$CHANGES" | jq -r '.[] | .data | "-- \(.action)::\t\(.path)"' | column -t -s $'::' | tac
echo '---'
