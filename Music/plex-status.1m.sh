#!/bin/bash

# <xbar.title>Plex Status</xbar.title>
# <xbar.version>v0.3</xbar.version>
# <xbar.author>Chris Bergeron</xbar.author>
# <xbar.author.github>chrisbergeron</xbar.author.github>
# <xbar.desc>See what's currently playing on your Plex</xbar.desc>
# <xbar.image>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</xbar.image>
# <xbar.dependencies>bash,imagemagick</xbar.dependencies>

# Put your plex hostname here
plexhost="plex-01"
#curlcmd=$(command -v curl)

# Put host to ping here (useful for vpn connections)
pinghost="plex-01"

# To do: Automate this from a curl response
# The UUID of your Plex Server.  This can be obtained from the browser address bar after selecting an item (it's between /server/ and /detail/)
serverid="YOUR SERVER ID HERE"

# Temp filename
tmpfile="/tmp/image.jpg"
touch $tmpfile
echo > /tmp/output.txt

# To do, retrieve Plex Token automatically, send username/password in Auth Request Header
#plextoken=$(curl -s -X POST \
#  'https://my.plexapp.com/users/sign_in.xml?X-Plex-Client-Identifier=my-app&Content-Length=0' \
#  -H 'cache-control: no-cache')

# Put your Plex API token here
plextoken=YOUR_PLEX_API_TOKEN_HERE

# If host is unreachable, display message and stop
if ! (ping -c1 -W1 $plexhost > /dev/null 2>&1); then
  echo "❌"
  echo "---"
  echo "Can't connect to $pinghost"
  exit
fi

# If we can connect to Plex, let's see what's playing and display it
if ! (curl -s http://$plexhost:32400/identity > /dev/null 2>&1); then
  echo "❌"
  echo "---"
  echo "Plex is unreachable | color=red"
  echo "$plexhost"
fi

# Get our session data from Plex
xmldata=$(curl -s -X GET \
  "http://plex-01:32400/status/sessions?X-Plex-Token=$plextoken" \
  -H 'Content-Length: 0' \
  -H 'X-Plex-Client-Identifier: my-app' \
  -H 'cache-control: no-cache')

echo "XMLDATA is: ($xmldata)" >> /tmp/output.txt

if (echo "$xmldata" | grep "Unauthorized"> /dev/null 2>&1); then
  echo -en "❌\n---\nUnauthorized.\nCheck your API Key."
  exit
fi
  
# Check to see if anything is playing, if not, say so and exit
if ! (echo "$xmldata" | grep "Video" > /dev/null 2>&1); then
  echo "○"
  echo "---"
  echo "Nothing playing"
  exit
fi

# Check to see if a trailer is playing, if so, exit
# To do: Display trailer info
if ! (echo "$xmldata" | grep "subtype=\"trailer\"" > /dev/null 2>&1); then
  echo "D"
  echo "---"
  echo "Preview Trailer Playing"
  exit
fi

# If metadata is a movie, parse it separately
if (echo "$xmldata" | grep "movie" > /dev/null 2>&1); then
  # We're watching a movie, parse as such
  thumblink=$(echo "$xmldata" | sed -e 's/>/\>\n/g' | head -n3 | tail -n1 | cut -f4 -d "\"" | sed -e 's/art/thumb/g')
  keydata="%2Flibrary%2Fmetadata%2F"$(echo "$thumblink" | cut -f4 -d "/")
else
  # We're watching TV, parse as such
  thumblink=$(echo "$xmldata" | sed -e 's/" /\n/g' | grep grandparentThumb | cut -f2 -d "\""| head -n1)
  keydata=$(echo "$xmldata" | sed -e 's/" /\n/g' | grep "key" | head -n1 | cut -f2 -d "\"" | sed -e 's/\//%2F/g' | head -n1)
fi

# Debug info
#echo "thumbnail link is: ($thumblink)" >> /tmp/output.txt
#echo "keydata for url is: ($keydata)" >> /tmp/output.txt

curl -s -o /tmp/image.jpg -X GET \
  "http://plex-01:32400$thumblink?X-Plex-Token=$plextoken" \
  -H 'Content-Length: 0' \
  -H 'X-Plex-Client-Identifier: my-app' \
  -H 'cache-control: no-cache'

# Resize our image to a small thumbnail
#mogrify -scale 75x100 $tmpfile
if ! (mogrify -scale 75x100 /tmp/image.jpg >> /tmp/output.txt 2>&1); then
  echo "---"
  echo "Couldn't render thumbnail image"
  exit
fi

# Encode our image into base64 text for BitBar
imgstr=$(base64 /tmp/image.jpg)

# Display our menu output
echo "| templateImage=iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAAAmJLR0QA/4ePzL8AAAAJcEhZcwAAC4kAAAuJATfJy60AAAAHdElNRQfjAhMPKzgxRmpXAAAAuUlEQVQoz5XRMU4CYRQE4O93LbCFtZDQ2dGItS2n4AKchFNwAbnIVhYmW1GTEBJDgiGRbh+FGyPwR+I0r5iZvHlvgGSmEcLeUBalWghhofubKNr55dNYBw823sW5gLW+Z0lH6c3mUnCw8mQgGbhVOZwL+FB4cSd5tFTnonYt2qi1Mn/N0F4IjZkEN/6FKysKU1sh7Exy/pFKIzTmepd0z7ylK6Ocf2InhK3pyXda3P+U9Xpa1jf+qPsIyJ5B7rJwvZwAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTktMDItMTlUMjA6NDQ6MDAtMDU6MDBDoNoZAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE5LTAyLTE5VDIwOjQzOjU2LTA1OjAw+xFCggAAAABJRU5ErkJggg=="
echo "---"
#  echo "Now Playing | color=green"
echo "Now Playing | color=orange"
echo "| image=$imgstr href=http://plex-01:32400/web/index.html#!/server/$serverid/details?key=$keydata"
