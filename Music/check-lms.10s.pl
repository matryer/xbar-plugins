#!/usr/bin/perl -w

# <bitbar.title>Logitech Media Server Status Display</bitbar.title>
# <bitbar.version>v1.1.0</bitbar.version>
# <bitbar.author>Michael Herger</bitbar.author>
# <bitbar.author.github>michaelherger</bitbar.author.github>
# <bitbar.desc>Show whether Logitech media Server is running or not. Quickly start/stop it, access its UI etc.</bitbar.desc>
# <bitbar.image>http://www.herger.net/slim/BitBar/lms-bitbar.png</bitbar.image>
# <bitbar.dependencies>Logitech Media Server</bitbar.dependencies>

use strict;

use constant PREFPANE_LINK => 'Open Preference Pane…|bash=/usr/bin/open param1=/Library/PreferencePanes/Squeezebox.prefPane terminal=false';

use constant LMS_ON => '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';
use constant LMS_OFF => 'iVBORw0KGgoAAAANSUhEUgAAACQAAAAkCAYAAADhAJiYAAAAAXNSR0IArs4c6QAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAgtpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDUuNC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpSZXNvbHV0aW9uVW5pdD4yPC90aWZmOlJlc29sdXRpb25Vbml0PgogICAgICAgICA8dGlmZjpDb21wcmVzc2lvbj4xPC90aWZmOkNvbXByZXNzaW9uPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICAgICA8dGlmZjpQaG90b21ldHJpY0ludGVycHJldGF0aW9uPjI8L3RpZmY6UGhvdG9tZXRyaWNJbnRlcnByZXRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+Cg9FKpMAAAc8SURBVFgJjdjJa1XZFgbwc3NjorEXVGwCigMLxBZsEAXBUcqRE8E3EeHNyj/nvZE1riodiYOXiRMnIgqCiE1AEPsGe42a6E1q/Xa5DjuXat6GdXe3mm99u7nnnE4T5ezZs91jx471bty4Mdrr9U4NDQ2NhWzu/lGaqJqZmZnm27dvRb5+/dqQ0C1ijszOzjYDAwPN4OBgsVGHn7Zvjq+w7U1NTU2E/O/Lly//3bNnz8PE0MnGtWvXjnc6nZ/XrFkzwvnHjx9LMEFSADCXJfQbIlDW2gkwQdb6CWrRokUF3NOnTz+F3r937979KywdylevXj2+ePHiX+bPn9+8e/duKpjqhuJAZNIJ5aIjoOyIzEk6V5MsgGMzmUxmAQy92fAxu3r16pmtW7f2VqxYMTw9Pd18+PDhX3v37v21c+XKldFg4M7KlStHnjx5Mn3mzJmhz58/N8PDwyWIwPPmzWtFP4ElCGCTRbXAJIEluARGBwjLefTo0enR0dGhV69eTUZCPwxGFqfWrVs38v79+6mgbJjzQF0CCM7ozwABQzcFOwIp/YCSKTUggC1YsKCJ/dOcO3du6OTJk1NByMIg5BSef+T09u3bXfvGsskswQCErZTcpAkIgGRHWzGX9uz4JNppL4axycnJZmJiovvd39hgNDZD+uzZsy4DzhmRdIIhfUb/VGpwEgWMXUrNKFD8Pn/+vBsnjs4Pg6EwwEnQGM1OuzwJBkh7BtX/TwFecD6z6GdCYijmLaG5qDv6MdcdTCO1bJINDhKMPRHXQQFWB6ptvzt0SsvekES/rjF+jeecsRpkC6hmh1FKbPbm0KFDza5du4qTNK7BaAMt2/v37zfnz58v4Gsdc5LFSm56oIylT3ULKA0SCLYoMFq6dGnxrZ3GdTDtHI/7rGUy7c3zy2cyZ/8AlktMR2l3KUWTjAiAWRj+VUnqs6abwNU57qgr4jjyYhFAjWVpowKQYGqFzJxBDTId5Hz/HCD8CapYqtzExkZGRgqQ/uTnLJlJYDIIRxxnsIsXL5b/OHqZOV2s0Dl8+HCbrcwttXn3m9vf0c6lc4qNiVcTMAeQiQwOjCIwp9b81q1bxWkN6A+tpjjfv39/sceAEyoon0C8efOm+fTpU2FJXxzz6jrmHED9kxksGbP2dPoBmTeeenmH6VsaDBL7SGIKH0DXdmW8zH7/SYf1mDZHDLGVznPJzLMznmwKBLygyYb5XDo2ydxfAuI0JYOpOY2/lWbJkiUFFGd/V/jIYIBZPv1s2zeKMb4BqsvcXswkmFQSwNjr16/L+mc/59W1Td02R1/QOrA2QOpaX7sFpIPWdMIRUTJjOin9ehlYbYn992EjlzjH9JMZvuwpdZZ2U1M0wTBpZeivQxBthY6+O8VTgjbRtkdk7Xhr5w1P12OGU0Y395Vx8RKQuRaQQQY2486dO5tly5YVY/vH8y9AaUhv4cKFzbZt28qcZOIRogQVREKC0tEnL168KKCXL19e5jJe/oXMYQgyRuojR4408fTWLt/GjRsLECAyext8bGys8b8FjLJp06ZiLzCGMCZ75fHjx83bt2/LPED8mMc++7wKgCwMARIP2c327dubeJwtTDHKgh2nhR7qDxw4UB5zMdGvR1cQ/u7evVv2n8CCrl+/vtxL/ADIl/EEbrxdMpvQ0gicRxUgzgXBYD6k5StM7gV6HOdFR8+FCFQWrK9ataokIJF4fi7MYzMZoltoKFRF0Hi2LfY1MHtKIHMyBfbhw4elNpcJ2C/YunnzZkmCTxkTAb04uMEleO/evbLPMNMPqDDEWLaXL18utB48eLCwxRkQ169fby5dulQcGouXyjIf71VljL0lYE8XuHoZzD969KgAs/lfvnxZgAGDzZqhdskMymB8fLyJd7Um3pUKSH+K1hprslOwcuHCBS+YjU3K1mbmHJg6QDLl0dblqk9satsAKH1F3QLSMWmt1TYkgAL0B2EMID3LhzUM2zc1GHp1oZcg2GKRZKLmAepFoxsbdzacdWw4NzMwCZJBXvUZIJcEECWd5nxdmwM0DwYmATLOTzA+Gxi8efQGYnBC8LVr1/byGFPWdveoiTEOOeYoRb9/rJ5LRixRLUApfMcbTc/BCbs73snGMeHF30XnynfMIc+MgEkxljSz6y/GAKoZSVs1IOwxbm+6ZLds2dJjFzLefmyIO2LkwYMH06dPn54XoDr2g2MMXB5tbWI8xbor3x22dbIkeILLtj62XBsnTpyY3rBhQ/uxoXjLzzEU4lRNxbHuxmYdiIzK5xjBEkCCTGC5t4xnEVDwZDOBAAl7LM9s/CPM7NixoxeHaBhzcYke37dv32/tByugwvnPsZdGAHDLcqSt5DIkE8lMAtUn+nSSobQvTuJHAsQplVR8h5qMBHyw+q39YJVf0XzSCwc/heKPsUybQ8pXCQ44zqxlTjCRQNV0agbZOYUCa5tTh61PendC7N//xH/oo8TwO9Q1DoOHezIsAAAAAElFTkSuQmCC';

my $status = LMS_OFF;
my $INSTALLATION_FOLDER = '/Library/PreferencePanes/Squeezebox.prefPane/Contents/Resources';

my $items;

if ( !-d $INSTALLATION_FOLDER ) {
	$items = qq(
		Logitech Media Server can't be found|color=#ff0000
	);	
}
else {
	my $port = `$INSTALLATION_FOLDER/check-web.pl`;
	$port *= 1;
	
	if ( $port ) {
		$items = qq(
			Logitech Media Server is running
			Open Web Control…| href=http://localhost:$port
			Open Settings…| href=http://localhost:$port/settings/index.html
---
			Stop Logitech Media Server|bash=$INSTALLATION_FOLDER/stop-server.sh terminal=false refresh=true
		);
		$status = LMS_ON;
	}
	else {
		my $server = `$INSTALLATION_FOLDER/get-server.sh`;
 		$server =~ s/\s*//sig;

		if ( $server ) {
			$items = qq(
				Logitech Media Server is starting…
			);
		}
		else {
			$items = qq(
				Logitech Media Server is not running
				Start Logitech Media Server|bash=$INSTALLATION_FOLDER/start-server.sh terminal=false refresh=true
			);
		}
	}
		
	$items .= "\n---\n" . PREFPANE_LINK;
}

print qq(|image=$status
---
$items
);


1;